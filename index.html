<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>LIFF å•Ÿå‹•é é¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
    margin:0; padding:20px;
    font-family:"Noto Sans TC",system-ui;
    background:#ffffff;
    color:#333;
}

.container { max-width:480px; margin:0 auto; }

.title {
    font-size:20px;
    font-weight:600;
    margin-bottom:10px;
    display:flex; align-items:center;
}
.title img { width:28px; height:28px; margin-right:8px; }

#logBox {
    background:#f9f9f9;
    padding:15px;
    border-radius:12px;
    border:1px solid #ddd;
    min-height:140px;
    white-space:pre-line;
    font-size:14px;
}

#map {
    width:100%;
    height:300px;
    margin-top:15px;
    border-radius:12px;
    overflow:hidden;
}

.btn {
    width:100%;
    margin-top:18px;
    padding:14px;
    background:#06c755;
    border:0;
    color:#fff;
    border-radius:10px;
    font-size:16px;
    font-weight:600;
}
.btn:disabled {
    background:#8acfa6;
}
</style>
</head>

<body>
<div class="container">

    <div class="title">
        <img src="https://scdn.line-apps.com/n/line_register/img/logo_line.png">
        LIFF å•Ÿå‹•é é¢
    </div>

    <div id="logBox">ğŸ”„ æº–å‚™ä¸­â€¦</div>

    <!-- åœ°åœ– -->
    <div id="map"></div>

    <!-- é€²å…¥æŒ‰éˆ• -->
    <button id="btnEnter" class="btn" disabled>é€²å…¥éŠæˆ²</button>

</div>

<script>
/* ===========================
   åŸºç¤è¨­å®š
=========================== */
const BASE_URL = "https://www.deepdreamgame.tw/endgame/";
const LIFF_ID = "2008129352-kv8pmz6V";

const logBox = document.getElementById("logBox");
function log(msg){ logBox.textContent += msg + "\n"; }

let USER_ID = null;
let USER_STATE = "ç©å®¶æº–å‚™ä¸­â€¦"; // ç©å®¶è¼¸å…¥æˆ–éŠæˆ²å…§åˆ¤æ–·
let LAT = null;
let LON = null;
let ACCURACY = null;
let ROAD = "æœªçŸ¥é“è·¯";

/* ===========================
   Web GPS
=========================== */
function getWebGPS(){
    return new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition(
            pos=>resolve(pos.coords),
            err=>reject(err),
            {enableHighAccuracy:true, timeout:8000}
        );
    });
}

/* ===========================
   åæŸ¥é“è·¯åç¨± (Nominatim)
=========================== */
async function reverseGeocode(lat, lon) {
    try {
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=zh-TW`;
        const response = await fetch(url);
        const data = await response.json();
        return data.address?.road || data.address?.footway || "æœªçŸ¥é“è·¯";
    } catch (e) {
        return "ç„¡æ³•ç²å–é“è·¯è³‡è¨Š";
    }
}

/* ===========================
   åˆå§‹åŒ– LIFF
=========================== */
async function initApp(){
    log("ğŸ”„ åˆå§‹åŒ– LIFFâ€¦");

    try {
        await liff.init({liffId:LIFF_ID});
        await liff.ready;
        log("âœ… LIFF åˆå§‹åŒ–å®Œæˆ");
    } catch(e){
        log("âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š"+e.message);
        enableButton();
        return;
    }

    /* ==== å–å¾— UID ==== */
    try{
        const prof = await liff.getProfile();
        USER_ID = prof.userId;
        log("ğŸ‘¤ ä½¿ç”¨è€… IDï¼š "+USER_ID);
    } catch(e){
        log("âš ï¸ ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼š"+e.message);
    }

    /* ==== GPS ==== */
    log("ğŸ“ å˜—è©¦å–å¾— GPSâ€¦");

    try{
        const gps = await getWebGPS();
        LAT = gps.latitude;
        LON = gps.longitude;
        ACCURACY = gps.accuracy;

        log(`ğŸ“Œ åº§æ¨™ï¼š${LAT.toFixed(6)}, ${LON.toFixed(6)}`);
        log(`ğŸ“ èª¤å·®ï¼šç´„ ${Math.round(ACCURACY)} å…¬å°º`);

        ROAD = await reverseGeocode(LAT, LON);
        log(`ğŸ›£ï¸ æ‰€åœ¨é“è·¯ï¼š${ROAD}`);
    } catch(e){
        log("âš ï¸ GPS å¤±æ•—ï¼š"+e.message);
        LAT = 25.04;
        LON = 121.56;
        ACCURACY = 999;
        ROAD = "ç„¡æ³•å®šä½";
    }

    initMap(LAT, LON);

    enableButton();
}

/* ===========================
   åœ°åœ–
=========================== */
function initMap(lat, lon){

    // æ˜äº®é«˜è¾¨è­˜åœ°åœ–
    const map = L.map("map").setView([lat, lon], 17);

    L.tileLayer(
        "https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        { maxZoom: 19 }
    ).addTo(map);

    L.marker([lat,lon]).addTo(map)
        .bindPopup(`ä½ åœ¨é€™è£¡ï¼<br>${ROAD}<br>èª¤å·®ï¼šç´„ ${Math.round(ACCURACY)} å…¬å°º`)
        .openPopup();
}

/* ===========================
   æŒ‰éˆ•
=========================== */
function enableButton(){
    document.getElementById("btnEnter").disabled = false;
}

document.getElementById("btnEnter").addEventListener("click", ()=>{

    const url =
        BASE_URL + 
        "?uid=" + encodeURIComponent(USER_ID) +
        "&state=" + encodeURIComponent(USER_STATE) +
        "&road=" + encodeURIComponent(ROAD) +
        "&acc=" + encodeURIComponent(ACCURACY);

    window.location.href = url;
});

/* ===========================
   å•Ÿå‹•
=========================== */
initApp();
</script>

</body>
</html>
