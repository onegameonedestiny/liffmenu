<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Cyberpunk Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
    margin:0; padding:20px;
    font-family:"Noto Sans TC",system-ui;
    background:#0a0c10;
    color:#e0e0e0;
}

.container { max-width:480px; margin:0 auto; }

.title {
    font-size:20px;
    font-weight:600;
    margin-bottom:10px;
    display:flex; align-items:center;
}
.title img { width:28px; height:28px; margin-right:8px; }

#logBox {
    background:rgba(15,18,25,0.85);
    padding:15px;
    border-radius:12px;
    border:1px solid #2d3340;
    min-height:150px;
    max-height:230px;
    overflow-y:auto;
    white-space:pre-line;
    font-size:14px;
    color:#99eaff;
    box-shadow:0 0 15px rgba(0,200,255,0.25);
}

/* åœ°åœ–å®¹å™¨ */
#map {
    position: relative;
    width: 100%;
    height: 300px;
    margin-top:18px;
    border-radius:12px;
    overflow:hidden;
    background:#000;
}

/* Fog of War */
#fog {
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
}

/* é›»å­å¹²æ“¾ç²’å­ */
#particleLayer {
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
}
.particle {
    position:absolute;
    width:2px; height:2px;
    background:#00eaff;
    opacity:0.6;
    animation: particleMove 1.5s linear infinite;
}
@keyframes particleMove {
    from { transform:translateY(0px); opacity:0.6; }
    to   { transform:translateY(25px); opacity:0; }
}

/* æƒæå…‰æŸ */
#scanner {
    position: absolute;
    top: -100%;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        rgba(0,255,255,0.18) 0%,
        rgba(0,255,255,0) 70%
    );
    animation: scanMove 3.5s linear infinite;
    pointer-events: none;
    mix-blend-mode: screen;
}
@keyframes scanMove {
    0%   { top:-100%; }
    100% { top:100%; }
}

/* æƒæç·š Scanlines */
#scanlines {
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
    background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.05) 0px,
        rgba(255,255,255,0.05) 1px,
        rgba(0,0,0,0.25) 2px,
        rgba(0,0,0,0.25) 3px
    );
    animation: flicker 2s infinite linear;
    mix-blend-mode: overlay;
}
@keyframes flicker {
    0%   { opacity:0.18; }
    50%  { opacity:0.33; }
    100% { opacity:0.18; }
}

/* æŒ‰éˆ• */
#openBtn {
    width:100%; margin-top:22px;
    padding:14px;
    background:#06c755;
    border:0;
    color:#fff;
    border-radius:10px;
    font-size:17px; font-weight:600;
    box-shadow:0 3px 10px rgba(6,199,85,0.35);
}
#openBtn:disabled {
    background:#3f6f52;
    box-shadow:none;
}
</style>
</head>

<body>
<div class="container">

    <div class="title">
        <img src="https://scdn.line-apps.com/n/line_register/img/logo_line.png">
        LIFF åˆå§‹åŒ–
    </div>

    <div id="logBox">ğŸ”„ æº–å‚™ä¸­â€¦</div>

    <!-- åœ°åœ– -->
    <div id="map">
        <canvas id="fog"></canvas>
        <div id="particleLayer"></div>
        <div id="scanner"></div>
        <div id="scanlines"></div>
    </div>

    <button id="openBtn" disabled>é–‹å•ŸéŠæˆ²é é¢</button>

</div>

<script>
/* ===========================
   åŸºç¤è¨­å®š
=========================== */
const WEBVIEW_URL = "https://www.deepdreamgame.tw/water/";
const LIFF_ID = "2008129352-kv8pmz6V";

const logBox = document.getElementById("logBox");
function log(msg){ logBox.textContent += msg + "\n";}

/* ===========================
   Web GPS
=========================== */
function getWebGPS(){
    return new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition(
            pos=>resolve(pos.coords),
            err=>reject(err),
            {enableHighAccuracy:true, timeout:8000}
        );
    });
}

/* ===========================
   åˆå§‹åŒ– LIFF
=========================== */
async function initApp(){
    log("ğŸ”„ åˆå§‹åŒ– LIFFâ€¦");

    try {
        await liff.init({liffId:LIFF_ID});
        await liff.ready;
        log("âœ… LIFF åˆå§‹åŒ–å®Œæˆ");
    } catch(e){
        log("âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š"+e.message);
        enableButton();
        return;
    }

    // å–å¾— LINE ID
    try{
        const prof = await liff.getProfile();
        localStorage.setItem("line_uid", prof.userId);
        log("ğŸ‘¤ ä½¿ç”¨è€… IDï¼š "+prof.userId);
    } catch(e){
        log("âš ï¸ ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼š"+e.message);
    }

    // GPS
    let lat=25.04, lon=121.56;
    log("ğŸ“ å˜—è©¦å–å¾— GPSâ€¦");

    try{
        const gps = await getWebGPS();
        lat = gps.latitude;
        lon = gps.longitude;
        log("ğŸ“Œ åº§æ¨™ï¼š"+lat+", "+lon);
    } catch(e){
        log("âš ï¸ GPS å¤±æ•—ï¼š"+e.message);
    }

    initMap(lat, lon);
    log("ğŸ‰ å®Œæˆåˆå§‹åŒ–");
    enableButton();
}

/* ===========================
   å»ºç«‹åœ°åœ– + Cyberpunk æ•ˆæœ
=========================== */
function initMap(lat, lon){
    log("ğŸ—ºï¸ å»ºç«‹åœ°åœ–â€¦");

    const map = L.map("map").setView([lat,lon],17);

    // é«˜è¾¨è­˜åœ°åœ–ï¼ˆè¡—é“æ¸…æ¥šï¼‰
    L.tileLayer(
        "https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {maxZoom:19}
    ).addTo(map);

    // æ¨™è¨˜ç©å®¶
    L.marker([lat,lon]).addTo(map).bindPopup("ä½ åœ¨é€™è£¡").openPopup();

    /* ========= Fog of War ========= */
    const fog = document.getElementById("fog");
    const ctx = fog.getContext("2d");

    function drawFog(){
        const w = fog.width  = fog.offsetWidth;
        const h = fog.height = fog.offsetHeight;

        // é»‘éœ§
        ctx.fillStyle = "rgba(0,0,0,0.65)";
        ctx.fillRect(0,0,w,h);

        // ç©å®¶äº®åœˆ
        const R = 120;
        const grd = ctx.createRadialGradient(w/2,h/2,10,w/2,h/2,R);
        grd.addColorStop(0,"rgba(0,0,0,0)");
        grd.addColorStop(1,"rgba(0,0,0,0.65)");

        ctx.globalCompositeOperation="destination-out";
        ctx.fillStyle = grd;
        ctx.fillRect(0,0,w,h);
        ctx.globalCompositeOperation="source-over";
    }
    drawFog();

    map.on("move", drawFog);
    map.on("zoom", drawFog);

    /* ========= é›»å­å¹²æ“¾ç²’å­ ========= */
    const layer = document.getElementById("particleLayer");
    for(let i=0;i<40;i++){
        const p = document.createElement("div");
        p.className="particle";
        p.style.left = Math.random()*100+"%";
        p.style.top  = Math.random()*100+"%";
        p.style.animationDelay = Math.random()*2+"s";
        layer.appendChild(p);
    }
}

/* ===========================
   æŒ‰éˆ•
=========================== */
function enableButton(){ document.getElementById("openBtn").disabled=false; }

document.getElementById("openBtn").addEventListener("click",()=>{
    liff.openWindow({url:WEBVIEW_URL, external:true});
});

initApp();
</script>

</body>
</html>
