<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>LIFF åˆå§‹åŒ–é é¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { margin:0; padding:12px; font-family:system-ui; }
        #logBox {
            padding:12px; background:#f4f4f4; border-radius:8px;
            min-height:150px; white-space:pre-line; font-size:14px;
            border:1px solid #ccc;
        }
        #openBtn {
            width:100%; margin-top:20px; padding:12px;
            background:#06c755; border:0; color:#fff;
            border-radius:8px; font-size:16px;
        }
    </style>
</head>
<body>

<script>
    const WEBVIEW_URL = "https://disasterpr.fun/Game/DisasterPR_Beta1.286/index.html";
    const LIFF_ID = "2008129352-kv8pmz6V";
</script>

<h3>LIFF åˆå§‹åŒ–ç‹€æ…‹</h3>
<div id="logBox">æº–å‚™ä¸­â€¦</div>
<button id="openBtn" disabled>é–‹å•ŸéŠæˆ²é é¢</button>

<script>
const logBox = document.getElementById("logBox");
const openBtn = document.getElementById("openBtn");

function log(msg) {
    console.log(msg);
    logBox.textContent += msg + "\n";
}

async function initApp() {
    log("ğŸ”„ åˆå§‹åŒ– LIFFâ€¦");

    try {
        await liff.init({ liffId: LIFF_ID });
        await liff.ready;
        log("âœ… LIFF åˆå§‹åŒ–å®Œæˆ");
    } catch (e) {
        log("âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
        return;
    }

    if (!liff.isLoggedIn()) {
        log("ğŸ” æœªç™»å…¥ï¼Œæ­£åœ¨å°å‘ç™»å…¥â€¦");
        return liff.login();
    }

    log("ğŸ”„ å–å¾— LINE ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™â€¦");

    let uid;
    try {
        const prof = await liff.getProfile();
        uid = prof.userId;
        log("âœ… ä½¿ç”¨è€… IDï¼š" + uid);
    } catch (e) {
        log("âŒ ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼š" + e.message);
        return;
    }

    log("ğŸ”„ å˜—è©¦å–å¾— GPSâ€¦");

    let lat = null, lon = null;
    try {
        const loc = await liff.getCurrentLocation();
        lat = loc.latitude;
        lon = loc.longitude;
        log(`âœ… GPS æˆåŠŸï¼š${lat}, ${lon}`);
    } catch (e) {
        log("âš ï¸ ç„¡æ³•å–å¾— GPSï¼š" + e.message);
        log("ğŸ‘‰ è«‹ç¢ºèªå·²å…è¨± LINE å®šä½æ¬Šé™");
        return;
    }

    try {
        localStorage.setItem("line_uid", uid);
        localStorage.setItem("gps_lat", lat);
        localStorage.setItem("gps_lon", lon);
        log("ğŸ’¾ å·²å¯«å…¥ localStorage");
    } catch (e) {
        log("âŒ localStorage å¯«å…¥å¤±æ•—ï¼š" + e.message);
        return;
    }

    log("ğŸ‰ æ‰€æœ‰æµç¨‹å®Œæˆï¼");
    openBtn.disabled = false;
}

openBtn.addEventListener("click", () => {
    log("â¡ï¸ æ­£åœ¨è·³è½‰éŠæˆ²â€¦");
    window.location.href = WEBVIEW_URL;   // â­ æ”¹ç‚ºç´”è·³è½‰ï¼Œä¸ä½¿ç”¨ liff.openWindow
});

initApp();
</script>

</body>
</html>
