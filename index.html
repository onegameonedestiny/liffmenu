<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>LIFF åˆå§‹åŒ–ä¸­â€¦</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body {
            margin:0; padding:20px; 
            font-family: "Noto Sans TC", system-ui;
            background:#f7f9fc;
        }

        .container {
            max-width:480px;
            margin:0 auto;
        }

        .title {
            font-size:20px;
            font-weight:600;
            color:#333;
            display:flex;
            align-items:center;
            margin-bottom:10px;
        }

        .title img {
            width:26px; height:26px; 
            margin-right:8px;
        }

        #logBox {
            background:white;
            padding:15px;
            border-radius:10px;
            border:1px solid #e2e2e2;
            min-height:180px;
            max-height:260px;
            overflow-y:auto;
            white-space:pre-line;
            font-size:14px;
            line-height:1.45;
            color:#444;
            box-shadow:0 2px 5px rgba(0,0,0,0.05);
        }

        #openBtn {
            width:100%; 
            margin-top:22px; 
            padding:14px;
            background:#06c755;
            border:0; 
            color:#fff;
            border-radius:10px; 
            font-size:17px;
            font-weight:600;
            box-shadow:0 3px 10px rgba(6,199,85,0.3);
        }

        #openBtn:disabled {
            background:#a6d8b9;
            box-shadow:none;
        }

        /* Loading åœ“åœˆ */
        .loader {
            width:24px;
            height:24px;
            border:3px solid #ccc;
            border-top-color:#06c755;
            border-radius:50%;
            animation:spin 1s linear infinite;
            display:inline-block;
            vertical-align:middle;
            margin-right:6px;
        }

        @keyframes spin {
            to { transform:rotate(360deg); }
        }
    </style>
</head>

<body>
<div class="container">

    <div class="title">
        <img src="https://scdn.line-apps.com/n/line_register/img/logo_line.png">
        LIFF åˆå§‹åŒ–ç‹€æ…‹
    </div>

    <div id="logBox">ğŸ”„ æº–å‚™ä¸­â€¦</div>

    <button id="openBtn" disabled>é–‹å•ŸéŠæˆ²é é¢</button>
</div>

<script>

const WEBVIEW_URL = "https://www.deepdreamgame.tw/water/";
const LIFF_ID = "2008129352-kv8pmz6V";

const logBox = document.getElementById("logBox");
const openBtn = document.getElementById("openBtn");

function log(msg) { logBox.textContent += msg + "\n"; }

// ============ Web GPS ============

function getWebGPS() {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
            pos => resolve(pos.coords),
            err => {
                let errorMsg;
                switch (err.code) {
                    case 1:
                        errorMsg = "æ¬Šé™æ‹’çµ•ï¼šè«‹æª¢æŸ¥ LINE èˆ‡æ‰‹æ©Ÿçš„å®šä½æ¬Šé™æ˜¯å¦é–‹å•Ÿã€‚";
                        break;
                    case 2:
                        errorMsg = "ç„¡æ³•å–å¾—ä½ç½®ï¼šå¯èƒ½åœ¨å®¤å…§æˆ– GPS è¨Šè™Ÿä¸ä½³ã€‚";
                        break;
                    case 3:
                        errorMsg = "å®šä½é€¾æ™‚ï¼šå¯èƒ½è¨Šè™Ÿå¼±ï¼Œè«‹ç¨å€™å†è©¦ã€‚";
                        break;
                    default:
                        errorMsg = `æœªçŸ¥éŒ¯èª¤ (${err.code}): ${err.message}`;
                }
                reject(new Error(errorMsg)); 
            },
            { enableHighAccuracy: true, timeout: 8000 }
        );
    });
}

// ============ App åˆå§‹åŒ– ============

async function initApp() {
    log("ğŸ”„ åˆå§‹åŒ– LIFFâ€¦");

    try {
        await liff.init({ liffId: LIFF_ID });
        await liff.ready;
        log("âœ… LIFF åˆå§‹åŒ–å®Œæˆ");
    } catch (e) {
        log("âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
        enableButton();
        return;
    }

    // å–å¾— UID
    let uid = null;
    try {
        const prof = await liff.getProfile();
        uid = prof.userId;
        localStorage.setItem("line_uid", uid);
        log("ğŸ‘¤ ä½¿ç”¨è€… IDï¼š" + uid);
    } catch (e) {
        log("âš ï¸ ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼š" + e.message);
    }

    // GPS
    log("ğŸ“ å˜—è©¦å–å¾— GPSâ€¦");
    try {
        const gps = await getWebGPS();
        localStorage.setItem("gps_lat", gps.latitude);
        localStorage.setItem("gps_lon", gps.longitude);
        log(`ğŸ“Œ ä½ç½®ï¼š${gps.latitude}, ${gps.longitude}ï¼ˆç²¾æº–åº¦ Â±${Math.round(gps.accuracy)}mï¼‰`);
    } catch (e) {
        log("âš ï¸ GPS å¤±æ•—ï¼š" + e.message);
    }

    log("ğŸ‰ å®Œæˆï¼Œå¯ä»¥é–‹å§‹éŠæˆ²ï¼");
    enableButton();
}

function enableButton() {
    openBtn.disabled = false;
}

// ========== è·³è½‰éŠæˆ² ==========

openBtn.addEventListener("click", () => {
    liff.openWindow({
        url: WEBVIEW_URL,
        external: true
    });
});

initApp();
</script>

</body>
</html>
