<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>LIFF å•Ÿå‹•é é¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
    margin:0; padding:20px;
    font-family:"Noto Sans TC",system-ui;
    background:#ffffff;
    color:#333;
}

.container { max-width:480px; margin:0 auto; }

.title {
    font-size:20px;
    font-weight:600;
    margin-bottom:10px;
    display:flex; align-items:center;
}
.title img { width:28px; height:28px; margin-right:8px; }

#logBox {
    background:#f9f9f9;
    padding:15px;
    border-radius:12px;
    border:1px solid #ddd;
    min-height:160px;
    white-space:pre-line;
    font-size:14px;
}

#map {
    width:100%;
    height:300px;
    margin-top:15px;
    border-radius:12px;
    overflow:hidden;
}

.btn {
    width:100%;
    margin-top:18px;
    padding:14px;
    background:#06c755;
    border:0;
    color:#fff;
    border-radius:10px;
    font-size:16px;
    font-weight:600;
}
.btn:disabled {
    background:#8acfa6;
}
</style>
</head>

<body>
<div class="container">

    <div class="title">
        <img src="https://scdn.line-apps.com/n/line_register/img/logo_line.png">
        LIFF å•Ÿå‹•é é¢
    </div>

    <div id="logBox">ğŸ”„ æº–å‚™ä¸­â€¦</div>

    <!-- åœ°åœ– -->
    <div id="map"></div>

    <!-- é€²å…¥æŒ‰éˆ• -->
    <button id="btnEnter" class="btn" disabled>é€²å…¥éŠæˆ²</button>

</div>

<script>
/* ===========================
   åŸºç¤è¨­å®š
=========================== */
const BASE_URL = "https://www.deepdreamgame.tw/endgame/";
const LIFF_ID = "2008129352-kv8pmz6V";

const logBox = document.getElementById("logBox");
function log(msg){ logBox.textContent += msg + "\n"; }

let profileData = {};
let LAT = null;
let LON = null;
let ACCURACY = null;
let ROAD = "æœªçŸ¥é“è·¯";

/* ===========================
   å–å¾—ä½¿ç”¨è€…è³‡æ–™
=========================== */
async function getUserProfile() {
    try {
        const profile = await liff.getProfile();
        return {
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl,
            statusMessage: profile.statusMessage || "æœªè¨­å®šç‹€æ…‹"
        };
    } catch (error) {
        log("âŒ ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼š" + error.message);
        return null;
    }
}

/* ===========================
   Web GPS
=========================== */
function getWebGPS(){
    return new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition(
            pos=>resolve(pos.coords),
            err=>reject(err),
            {enableHighAccuracy:true, timeout:8000}
        );
    });
}

/* ===========================
   åæŸ¥é“è·¯åç¨± (Nominatim)
=========================== */
async function reverseGeocode(lat, lon) {
    try {
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=zh-TW`;
        const response = await fetch(url);
        const data = await response.json();
        return data.address?.road || data.address?.footway || "æœªçŸ¥é“è·¯";
    } catch (e) {
        return "ç„¡æ³•ç²å–é“è·¯è³‡è¨Š";
    }
}

/* ===========================
   åˆå§‹åŒ– LIFF
=========================== */
async function initApp(){
    log("ğŸ”„ åˆå§‹åŒ– LIFFâ€¦");

    try {
        await liff.init({liffId:LIFF_ID});
        await liff.ready;
        log("ğŸ“² LIFF åˆå§‹åŒ–å®Œæˆ");
    } catch(e){
        log("âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š"+e.message);
        enableButton();
        return;
    }

    // å–å¾—ä½¿ç”¨è€…è³‡æ–™
    profileData = await getUserProfile();
    if (profileData) {
        log(`ğŸ‘¤ ä½¿ç”¨è€…ï¼š${profileData.displayName}`);
        log(`ğŸ†” IDï¼š${profileData.userId}`);
        log(`ğŸ–¼ï¸ é ­åƒï¼š${profileData.pictureUrl}`);
        log(`ğŸ’¬ ç‹€æ…‹ï¼š${profileData.statusMessage}`);
    }

    // å–å¾— GPS
    log("ğŸ“ å˜—è©¦å–å¾— GPSâ€¦");
    try{
        const gps = await getWebGPS();
        LAT = gps.latitude;
        LON = gps.longitude;
        ACCURACY = gps.accuracy;

        log(`ğŸ“Œ åº§æ¨™ï¼š${LAT.toFixed(6)}, ${LON.toFixed(6)}`);
        log(`ğŸ“ èª¤å·®ï¼šç´„ ${Math.round(ACCURACY)} å…¬å°º`);

        ROAD = await reverseGeocode(LAT, LON);
        log(`ğŸ›£ï¸ æ‰€åœ¨é“è·¯ï¼š${ROAD}`);
    } catch(e){
        log("âš ï¸ GPS å¤±æ•—ï¼š"+e.message);
        LAT = 25.04;
        LON = 121.56;
        ACCURACY = 999;
        ROAD = "ç„¡æ³•å®šä½";
    }

    initMap(LAT, LON);
    enableButton();
}

/* ===========================
   åœ°åœ–
=========================== */
function initMap(lat, lon){

    const map = L.map("map").setView([lat, lon], 17);

    L.tileLayer(
        "https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        { maxZoom: 19 }
    ).addTo(map);

    L.marker([lat,lon]).addTo(map)
        .bindPopup(`ä½ åœ¨é€™è£¡ï¼<br>${ROAD}<br>èª¤å·®ï¼šç´„ ${Math.round(ACCURACY)} å…¬å°º`)
        .openPopup();
}

/* ===========================
   å…¨è¢å¹•å¾Œå°é 
=========================== */
async function enterFullscreenAndRedirect(url) {
    const docEl = document.documentElement;

    if (docEl.requestFullscreen) {
        try {
            await docEl.requestFullscreen();
            log("ğŸ–¥ï¸ å·²é€²å…¥å…¨è¢å¹•");
        } catch (e) {
            log("âš ï¸ å…¨è¢å¹•å¤±æ•—ï¼š" + e.message);
        }
    } else {
        log("âš ï¸ æ­¤è£ç½®ä¸æ”¯æ´å…¨è¢å¹• API");
    }

    setTimeout(() => {
        window.location.href = url;
    }, 300);
}

/* ===========================
   æŒ‰éˆ•
=========================== */
function enableButton(){
    document.getElementById("btnEnter").disabled = false;
}

document.getElementById("btnEnter").addEventListener("click", ()=>{

    const url =
        BASE_URL +
        "?uid=" + encodeURIComponent(profileData.userId) +
        "&name=" + encodeURIComponent(profileData.displayName) +
        "&pic=" + encodeURIComponent(profileData.pictureUrl) +
        "&status=" + encodeURIComponent(profileData.statusMessage) +
        "&lat=" + encodeURIComponent(LAT) +
        "&lon=" + encodeURIComponent(LON) +
        "&acc=" + encodeURIComponent(ACCURACY) +
        "&road=" + encodeURIComponent(ROAD);

    enterFullscreenAndRedirect(url);
});

/* ===========================
   å•Ÿå‹•
=========================== */
initApp();
</script>

</body>
</html>
