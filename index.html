<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>LIFF å•Ÿå‹•é é¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

<style>
body {
    margin:0; padding:20px;
    font-family:"Noto Sans TC",system-ui;
    background:#ffffff;
    color:#333;
}

.container { max-width:480px; margin:0 auto; }

.title {
    font-size:20px;
    font-weight:600;
    margin-bottom:10px;
    display:flex; align-items:center;
}
.title img { width:28px; height:28px; margin-right:8px; }

#logBox {
    background:#f9f9f9;
    padding:15px;
    border-radius:12px;
    border:1px solid #ddd;
    min-height:140px;
    white-space:pre-line;
    font-size:14px;
}

.btn {
    width:100%;
    margin-top:18px;
    padding:14px;
    background:#06c755;
    border:0;
    color:#fff;
    border-radius:10px;
    font-size:16px;
    font-weight:600;
}
.btn:disabled {
    background:#8acfa6;
}
</style>
</head>

<body>
<div class="container">

    <div class="title">
        <img src="https://scdn.line-apps.com/n/line_register/img/logo_line.png">
        LIFF å•Ÿå‹•é é¢
    </div>

    <div id="logBox">ğŸ”„ æº–å‚™ä¸­â€¦</div>

    <!-- è¨»å†ŠæŒ‰éˆ• -->
    <button id="btnRegister" class="btn" disabled>ğŸ”° è¨»å†Š</button>

    <!-- ç™»å…¥æŒ‰éˆ• -->
    <button id="btnStart" class="btn" disabled>ğŸš€ é–‹å§‹éŠæˆ²</button>

</div>

<script>
/* ===========================
   åŸºç¤è¨­å®š
=========================== */
const BASE_URL_REGISTER = "https://www.deepdreamgame.tw/linesave/";
const BASE_URL_START = "https://www.deepdreamgame.tw/gettest/";
const LIFF_ID = "2008129352-kv8pmz6V";

const logBox = document.getElementById("logBox");
function log(msg){ logBox.textContent += msg + "\n"; }

let LINE_ID = null;
let firestore = null;

/* ===========================
   åˆå§‹åŒ– LIFF
=========================== */
async function initApp(){
    log("ğŸ”„ åˆå§‹åŒ– LIFFâ€¦");

    try {
        await liff.init({liffId:LIFF_ID});
        await liff.ready;
        log("ğŸ“² LIFF åˆå§‹åŒ–å®Œæˆ");
    } catch(e){
        log("âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š"+e.message);
        enableButtons(false);
        return;
    }

    // å–å¾— LINE ä½¿ç”¨è€…è³‡è¨Š
    try {
        const prof = await liff.getProfile();
        LINE_ID = prof.userId;
        log(`ğŸ‘¤ ä½¿ç”¨è€… IDï¼š${LINE_ID}`);
    } catch(e) {
        log("âš ï¸ ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼š"+e.message);
        return;
    }

    // åˆå§‹åŒ– Firebase
    initFirebase();

    enableButtons(true);
}

/* ===========================
   Firebase
=========================== */
function initFirebase() {
    const firebaseConfig = {
        apiKey: "AIzaSyCK7sNXMML-IA_ZjaiAOXyN8ftCrLn39uA",
        authDomain: "theendoftheworld.firebaseapp.com",
        projectId: "theendoftheworld",
    };

    firebase.initializeApp(firebaseConfig);
    firestore = firebase.firestore();
    log("ğŸ”¥ Firebase å·²åˆå§‹åŒ–");
}

/* ===========================
   æŒ‰éˆ•å•Ÿç”¨/åœç”¨
=========================== */
function enableButtons(enable){
    document.getElementById("btnRegister").disabled = !enable;
    document.getElementById("btnStart").disabled = !enable;
}

/* ===========================
   è¨»å†ŠåŠŸèƒ½
=========================== */
document.getElementById("btnRegister").addEventListener("click", ()=>{
    const url = `${BASE_URL_REGISTER}?lineid=${encodeURIComponent(LINE_ID)}`;
    window.location.href = url;
});

/* ===========================
   é–‹å§‹éŠæˆ²åŠŸèƒ½ï¼ˆæŸ¥ Firebase è³‡æ–™ï¼‰
=========================== */
document.getElementById("btnStart").addEventListener("click", async ()=>{

    try {
        log("ğŸ” æŸ¥è©¢ç©å®¶è¨»å†Šè³‡æ–™ä¸­...");
        
        // å¾ player_line é›†åˆæŸ¥è©¢ LINE ID æ–‡ä»¶
        const docRef = firestore.collection("player_line").doc(LINE_ID);
        const docSnap = await docRef.get();

        if (!docSnap.exists) {
            log("âŒ æœªè¨»å†Šï¼è«‹å…ˆé»æ“Šã€è¨»å†Šã€‘æŒ‰éˆ•");
            return;
        }

        log("ğŸ“¦ æ‰¾åˆ°ç©å®¶è³‡æ–™ï¼Œè§£æä¸­...");

        const data = docSnap.data();

        if (!data.plykey) {
            log("âš ï¸ plykey æ¬„ä½ä¸å­˜åœ¨ï¼");
            return;
        }

        const plykey = data.plykey;

        log(`ğŸ¯ plykey = ${plykey}`);
        log(`ğŸš€ æº–å‚™é–‹å•ŸéŠæˆ²é ...`);

        const url = `${BASE_URL_START}?lineid=${encodeURIComponent(LINE_ID)}&plykey=${encodeURIComponent(plykey)}`;
        window.location.href = url;

    } catch (e) {
        log("âŒ æŸ¥è©¢å¤±æ•—ï¼š" + e.message);
    }
});

/* ===========================
   å•Ÿå‹•
=========================== */
initApp();

</script>

</body>
</html>
